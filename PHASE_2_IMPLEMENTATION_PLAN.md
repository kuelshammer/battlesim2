# Phase 2 Implementation Plan: Action Data Structure & Frontend

## üîó Context
This document details the step-by-step implementation for **Phase 2** of the [Simulation Architecture Redesign](SIMULATION_ARCHITECTURE_REDESIGN.md).

**Goal:** Define the *new* action data structures in both backend and frontend, enabling users to immediately create flexible, programmable actions via the GUI. Old monster/spell JSON data will **not** be automatically migrated and will require manual re-creation or updating.

---

## üõ†Ô∏è Step-by-Step Implementation

### Part A: Backend (Rust) Data Structures

**File:** `simulation-wasm/src/model.rs` (and cleanup `enums.rs`)

1.  **Update `Action` Structs:**
    *   Modify `ActionBase` to replace `action_slot` with the new fields:
        ```rust
        pub struct ActionBase {
            // ... existing fields (id, name, freq, condition, targets)
            
            // REPLACED: action_slot
            pub cost: Vec<ActionCost>, 
            pub requirements: Vec<ActionRequirement>,
            pub tags: Vec<ActionTag>,
        }
        ```
    *   Ensure `ActionCost`, `ActionRequirement` are imported from `resources.rs`.
    *   Define `ActionTag` enum (Melee, Ranged, Spell, Weapon, etc.) in `resources.rs` or `enums.rs`.

2.  **Update `Frequency` Enum:**
    *   Evaluate if `Frequency` needs adjustment. For now, it might stay for "At Will", "Recharge", "Limited Uses" (like 1/Day). Note that "Limited Uses" can also be modeled as a `Resource` in the `ResourceLedger`, but keeping `Frequency` for simple cases might be useful during transition.
    *   *Decision:* Keep `Frequency` for now as a simple limiter, but encourage moving "Charges" to `ResourceLedger` later.

3.  **Clean Up `ActionSlot` Usage:**
    *   Mark `ActionSlot` in `enums.rs` as `#[deprecated]`.
    *   Update all struct definitions (`AtkAction`, `HealAction`, etc.) to include the new fields via `ActionBase` or directly if they don't use `base()`.
    *   *Note:* This will break existing code that relies on `action_slot`. We will need to temporarily fix compilation errors by commenting out or mocking the old logic in `simulation.rs` (since the logic rewrite is Phase 4). Or, for Phase 2, we can keep `action_slot` as `Option<i32>` for backward compatibility during the transition, but the goal is to move away.
    *   *Strategy:* Make `action_slot` optional (`#[serde(default)]`) to allow loading old data if needed, but focus on populating the new fields.

### Part B: Frontend (TypeScript) Data Structures

**File:** `src/model/model.ts`

1.  **Define TypeScript Interfaces:**
    *   Replicate `ActionCost`, `ActionRequirement`, `ActionTag`, `ResourceType` in TypeScript.
    *   Update `Action` and `FinalAction` interfaces to include `cost`, `requirements`, `tags`.
    *   Mark `actionSlot` as optional/deprecated.

**File:** `src/model/enums.ts`

1.  **Export New Enums:**
    *   Export `ResourceTypes`, `ActionTags`, `ResetTypes`.

### Part C: Frontend (GUI) Updates

**File:** `src/components/creatureForm/actionForm.tsx`

1.  **Resource/Cost Editor:**
    *   Create a new UI component `ActionCostEditor` to add/remove costs from a list.
    *   Allow selecting `ResourceType` (Action, Bonus, Slot Level) and Amount.

2.  **Requirement Editor:**
    *   Create `ActionRequirementEditor` to add/remove requirements.
    *   Allow selecting `RequirementType` (Resource Available, Combat State) and values.

3.  **Tag Editor:**
    *   Simple multi-select or tag input for `ActionTags`.

4.  **Update Main Action Form:**
    *   Replace the single "Action Slot" dropdown with the new `ActionCostEditor`.
    *   Add the `ActionRequirementEditor`.
    *   Add the `TagEditor`.

### Part D: Default Data Updates (Manual)

**File:** `src/data/actions.ts`

1.  **Update Templates:**
    *   Update `ActionTemplates` (Fireball, Cure Wounds, etc.) to use the new structure.
    *   *Example:* "Fireball"
        *   Old: `actionSlot: ActionSlots.Action`
        *   New: `cost: [{ type: 'Primary', name: 'Action', amount: 1 }, { type: 'SpellSlot', level: 3, amount: 1 }]`, `tags: ['Spell', 'Fire', 'AoE']`

---

## ‚úÖ Definition of Done (Phase 2)

Phase 2 is complete when:

1.  [ ] **Backend:** Rust structs in `model.rs` support `cost`, `requirements`, and `tags`.
2.  [ ] **Frontend:** TypeScript interfaces match the backend.
3.  [ ] **GUI:** Users can create a new action in the UI, add multiple costs (e.g., Action + Spell Slot), add requirements, and save it.
4.  [ ] **Verification:** The JSON generated by the frontend contains the new fields correctly formatted.
5.  [ ] **No Logic Changes:** The simulation logic (`execute_turn`) does **not** need to use these new fields yet (that's Phase 4). The goal is just data entry.
6.  [ ] **Compatibility:** Old data might fail to load or miss fields, which is acceptable per the plan (manual update required).
