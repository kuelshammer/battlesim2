#!/bin/bash
set -e

echo "üîç Pre-commit quality checks..."
echo ""

# Rust checks
echo "ü¶Ä Running Rust checks..."
cd simulation-wasm

# First check if code compiles (actual errors)
echo "  ‚Üí Checking compilation..."
cargo check --quiet 2>&1 | grep -i "^error" && {
    echo "‚ùå Code does not compile. Fix errors first."
    exit 1
} || echo "  ‚úì Compilation check passed"

# Then run clippy for warnings (non-blocking initially)
echo "  ‚Üí Running clippy..."
if CLIPPY_OUTPUT=$(cargo clippy --quiet 2>&1); then
    echo "  ‚úì Clippy passed (no warnings)"
else
    echo "  ‚ö†Ô∏è  Clippy warnings (non-blocking):"
    echo "$CLIPPY_OUTPUT" | grep "warning:" | head -3 || echo "     (run 'cargo clippy' to see details)"
    echo "  ‚ö†Ô∏è  To enforce these warnings later, change -W to -D in pre-commit hook"
fi

# Check if cargo-audit is available
if command -v cargo-audit &> /dev/null || cargo audit --version &> /dev/null 2>&1; then
    echo "  ‚Üí Running cargo audit..."
    cargo audit --quiet || {
        echo "  ‚ö†Ô∏è  Security vulnerabilities detected. Review with: cd simulation-wasm && cargo audit"
        # Don't fail on audit warnings, just warn
    }
else
    echo "  ‚ö†Ô∏è  cargo-audit not found (install with: cargo install cargo-audit)"
fi

cd ..
echo ""

# TypeScript/JavaScript checks
echo "üìù Running TypeScript/JavaScript checks..."

# ESLint
if [ -f "node_modules/.bin/eslint" ]; then
    echo "  ‚Üí Running ESLint..."
    npx eslint src/ --ext .ts,.tsx --max-warnings=0 || {
        echo "‚ùå ESLint found errors. Fix with: npm run lint:fix"
        exit 1
    }
else
    echo "  ‚ö†Ô∏è  ESLint not found, skipping..."
fi

# Prettier
if [ -f "node_modules/.bin/prettier" ]; then
    echo "  ‚Üí Checking code formatting..."
    npx prettier --check "src/**/*.{ts,tsx,scss,css}" || {
        echo "‚ùå Code formatting issues. Fix with: npm run format"
        exit 1
    }
else
    echo "  ‚ö†Ô∏è  Prettier not found, skipping..."
fi

echo ""

# WASM size check
if [ -f "simulation-wasm/pkg/simulation_wasm_bg.wasm" ]; then
    echo "üì¶ Checking WASM size..."
    # Get WASM file size (cross-platform)
    if command -v stat &> /dev/null; then
        WASM_SIZE=$(stat -f%z simulation-wasm/pkg/simulation_wasm_bg.wasm 2>/dev/null || stat -c%s simulation-wasm/pkg/simulation_wasm_bg.wasm 2>/dev/null || echo "0")
    else
        WASM_SIZE=$(wc -c < simulation-wasm/pkg/simulation_wasm_bg.wasm)
    fi

    # Convert to KB for display
    WASM_SIZE_KB=$((WASM_SIZE / 1024))
    echo "  ‚Üí Current WASM size: ${WASM_SIZE_KB}KB"

    # Baseline size (500KB - adjust after first real build)
    BASELINE_SIZE_KB=500
    THRESHOLD_PERCENT=10

    # Alert if grew > 10% from baseline (but only if we have a real baseline)
    if [ $WASM_SIZE_KB -gt 100 ]; then
        if [ $WASM_SIZE_KB -gt $((BASELINE_SIZE_KB * (100 + THRESHOLD_PERCENT) / 100)) ]; then
            echo "‚ö†Ô∏è  WASM grew > ${THRESHOLD_PERCENT}% from ${BASELINE_SIZE_KB}KB baseline"
            echo "   Consider: removing unused dependencies, enabling LTO, or wasm-opt"
            # Don't fail the commit, just warn
        fi
    fi
    echo ""
fi

# Run tests
echo "üß™ Running tests..."
echo "  ‚Üí Rust tests..."
cd simulation-wasm
cargo test --quiet || {
    echo "‚ùå Rust tests failed. Fix with: cd simulation-wasm && cargo test"
    exit 1
}
cd ..

echo "  ‚Üí TypeScript tests..."
if [ -f "package.json" ]; then
    npm test 2>&1 || {
        echo "‚ùå TypeScript tests failed."
        exit 1
    }
fi

echo ""
echo "‚úÖ All pre-commit checks passed!"
